{{ header | safe }}

{# ========== Constants and Configuration ========== #}
{% set CAP_OFFSET_PM = 0x40 %}
{% set CAP_OFFSET_MSI = 0x48 %}
{% set CAP_OFFSET_MSIX = 0x50 %}
{% set CAP_OFFSET_PCIE = 0x60 %}
{% set CAP_OFFSET_AER = 0xA0 %}
{% set EXTENDED_CFG_START = 0x100 %}
{% set EXTENDED_CFG_END = 0x1000 %}

{# ========== Helper Functions and Macros ========== #}

{# Import small helper macros for safe attribute access #}
{% from "_helpers.j2" import safe_name, safe_fpga_part, safe_attr, safe_int, get_vendor_id, get_device_id, get_subsystem_vendor_id, get_subsystem_device_id %}

{# Helper function to check if MSI-X is supported with consistent logic #}
{% macro is_msix_supported() %}
{{ (msix_config is defined) and (msix_config and (msix_config.is_supported if hasattr(msix_config, 'is_supported') else (msix_config.num_vectors|default(0) > 0))) }}
{% endmacro %}

{# Macro for BAR validation #}
{% macro validate_bar_configs() %}
{# Be permissive during migration: warn when bars are missing and emit disabled BARs instead of failing to render #}
{% if not bar_config or (bar_config.bars is defined and bar_config.bars|length == 0) %}
  ; Warning: no BAR configuration available - template will emit disabled BARs
{% endif %}
{% endmacro %}

{# Macro for formatting BAR entries consistently - NO DEFAULT VALUES allowed for base address #}
{% macro render_bar(index, bar=None, is_io=false) %}
{% set bar_name = "BAR" ~ index %}
{% if bar %}
  {% if (bar.size is defined and bar.size > 0) and hasattr(bar, 'get_size_encoding') %}
; {{ bar_name }}: {{ bar.bar_type | default('mem') }} BAR, Size: 0x{{ "%X" % (bar.size | safe_int(0)) }} bytes
{{ "%08X" % (bar.get_size_encoding() | safe_int(0)) }},
  {% elif bar.base_address is defined %}
; {{ bar_name }}: Using base address
{{ "%08X" % (bar.base_address | safe_int(0)) }},
  {% else %}
; {{ bar_name }}: Disabled (no size/base) - emitting zero
00000000,
  {% endif %}
{% else %}
  {% if not (bar_config is defined and bar_config.bars is defined and bar_config.bars|length > 0) %}
; {{ bar_name }}: Disabled (not configured)
00000000,
  {% else %}
; {{ bar_name }}: Disabled (not configured)
00000000,
  {% endif %}
{% endif %}
{% endmacro %}

{# ========== Comprehensive Validation (permissive) ========== #}
{# Provide safe local defaults so templates can render during migration. Runtime should validate strictly. #}
{% set config_space = config_space or {} %}
{% set bar_config = bar_config or {} %}
{% set device_config = device_config or {} %}
{% set timing_config = timing_config or {} %}
{% set pcileech_config = pcileech_config or {} %}
{% set msix_config = msix_config or {} %}

{# Local guarded variables for PCILeech config values used in comments or non-fatal output #}
{% set pcileech_command_timeout = pcileech_config.command_timeout if (pcileech_config is defined and pcileech_config.command_timeout is defined) else 1000 %}
{% set pcileech_buffer_size = pcileech_config.buffer_size if (pcileech_config is defined and pcileech_config.buffer_size is defined) else 4096 %}

{# Use centralized helper functions for consistent ID handling #}
{% set vendor_id_int = get_vendor_id(device_config, device, config_space, vendor_id_int) %}
{% set device_id_int = get_device_id(device_config, device, config_space, device_id_int) %}

; Device Information (fallbacks used when fields are missing):
; - Vendor ID: {{ get_vendor_id(device_config, device, config_space, vendor_id_int) }}
; - Device ID: {{ get_device_id(device_config, device, config_space, device_id_int) }}
; - Class Code: {{ safe_attr(config_space, 'class_code', '00') }}
; - Revision ID: {{ safe_attr(config_space, 'revision_id', '00') }}
;
; Generation Metadata:
; - Generated: {{ safe_attr(generation_metadata, 'generated_at', 'unknown') }}
; - Device BDF: {{ safe_attr(device_config, 'device_bdf', '00:00.0') }}
; - Has Behavior Profile: {{ safe_attr(device_config, 'behavior_profile', false) }}
; - MSI-X Vectors: {{ safe_attr(msix_config, 'num_vectors', 0) }}

memory_initialization_radix=16;
memory_initialization_vector=

{{ validate_bar_configs() }}
; =====================================================================
; Standard PCI Configuration Header (0x00-0x3F)
; =====================================================================

; Vendor ID (0x00-0x01) and Device ID (0x02-0x03)
{{ get_device_id(device_config, device, config_space, device_id_int) }}{{ get_vendor_id(device_config, device, config_space, vendor_id_int) }},

; Command Register (0x04-0x05) and Status Register (0x06-0x07)
; Command: Memory Space Enable + Bus Master Enable
; Status: Capabilities List + Fast Back-to-Back + 66MHz Capable
{% set command_register = "0210" if (safe_attr(device_config, 'enable_dma_operations', true)) else "0200" %}
{{ command_register }}0006,

; Revision ID (0x08), Programming Interface (0x09), Sub Class (0x0A), Base Class (0x0B)
{{ safe_attr(config_space, 'class_code', '00') | string }}{{ safe_attr(config_space, 'revision_id', '00') | string }},

; Cache Line Size (0x0C), Latency Timer (0x0D), Header Type (0x0E), BIST (0x0F)
00001010,

; Base Address Registers (0x10-0x27)
{% set bars = (bar_config.bars if (bar_config is defined and bar_config.bars is defined) else []) %}
{% set has_bars = (bars | length) > 0 %}

; BAR0 (0x10-0x13) - Memory BAR
{% if has_bars %}
{{ render_bar(0, bars[0]) }}
{% else %}
{{ render_bar(0) }}
{% endif %}

; BAR1 (0x14-0x17) - Upper 32 bits for 64-bit BAR or second BAR
{% if has_bars and (bars[0].is_64bit if bars|length > 0 and (bars[0] is not none) else False) %}
; BAR1: Upper 32 bits of 64-bit BAR0
FFFFFFFF,
{% elif has_bars and bars|length > 1 %}
{{ render_bar(1, bars[1]) }}
{% else %}
; BAR1: Disabled (not configured)
00000000,
{% endif %}

; BAR2 (0x18-0x1B) - I/O BAR or third memory BAR
{% if has_bars and bars|length > 2 %}
{{ render_bar(2, bars[2], true) }}
{% else %}
; BAR2: Disabled (not configured)
00000000,
{% endif %}

; BAR3 (0x1C-0x1F) - Fourth BAR
{% if has_bars and bars|length > 3 %}
{{ render_bar(3, bars[3]) }}
{% else %}
; BAR3: Disabled (not configured)
00000000,
{% endif %}

; BAR4 (0x20-0x23) - Fifth BAR
{% if has_bars and bars|length > 4 %}
{{ render_bar(4, bars[4]) }}
{% else %}
; BAR4: Disabled (not configured)
00000000,
{% endif %}

; BAR5 (0x24-0x27) - Sixth BAR
{% if has_bars and bars|length > 5 %}
{{ render_bar(5, bars[5]) }}
{% else %}
; BAR5: Disabled (not configured)
00000000,
{% endif %}

; Cardbus CIS Pointer (0x28-0x2B) - Unused
00000000,

; Subsystem Vendor ID (0x2C-0x2D) and Subsystem ID (0x2E-0x2F)
{% set has_device = device is defined %}
{% set has_subsys_device_id = has_device and hasattr(device, 'subsys_device_id') %}
{% set has_subsys_vendor_id = has_device and hasattr(device, 'subsys_vendor_id') %}
{% set valid_subsys_device_id = has_subsys_device_id and device.subsys_device_id != "0000" %}
{% set valid_subsys_vendor_id = has_subsys_vendor_id and device.subsys_vendor_id != "0000" %}
{# Subsystem IDs - use centralized helpers with proper fallbacks #}
{% set subsys_vid_str = get_subsystem_vendor_id(device_config, device, vendor_id_int) %}
{% set subsys_dev_str = get_subsystem_device_id(device_config, device, device_id_int) %}
{% if subsys_dev_str != '0000' and subsys_vid_str != '0000' %}
; Subsystem: {{ subsys_dev_str }}:{{ subsys_vid_str }}
{{ subsys_dev_str }}{{ subsys_vid_str }},
{% else %}
; Subsystem: Not configured
00000000,
{% endif %}

; Expansion ROM Base Address (0x30-0x33) - Disabled
00000000,

; Capabilities Pointer (0x34), Reserved (0x35-0x3B)
; Points to first capability at 0x40
{{ "%02X" % (CAP_OFFSET_PM | safe_int(0)) }}000000,

; Interrupt Line (0x3C), Interrupt Pin (0x3D), Min_Gnt (0x3E), Max_Lat (0x3F)
; Using INTA (0x01) for interrupt pin
0000010B,

; =====================================================================
; PCI Capabilities
; =====================================================================

; Power Management Capability ({{ CAP_OFFSET_PM }}-{{ CAP_OFFSET_PM + 7 }})
; Cap ID=0x01, Next=0x50, PMC=0x0003, PMCSR=0x0000
{% set next_cap = CAP_OFFSET_MSI %}
{% set pm_cap_header = "0003" ~ ("%02X" % (next_cap | safe_int(0))) ~ "01" %}
{{ pm_cap_header }},
00000000,

{# Define variables outside conditional blocks so they're always available #}
{% set msix_enabled = is_msix_supported() %}
{% set next_cap = CAP_OFFSET_PCIE %}
{% set msi_cap_header = "0080" ~ ("%02X" % (next_cap | safe_int(0))) ~ "05" %}
{% set msix_control = ("%04X" % ((msix_config.num_vectors - 1) | safe_int(0))) if (msix_config.num_vectors|default(0) > 0) else "0000" %}
{% set msix_cap_header = msix_control ~ ("%02X" % (next_cap | safe_int(0))) ~ "11" %}

; MSI Capability ({{ CAP_OFFSET_MSI }}-{{ CAP_OFFSET_MSI + 7 }})
{% if not msix_enabled %}
; Cap ID=0x05, Next=0x60, Message Control=0x0080 (64-bit capable)
{{ msi_cap_header }},
; Message Address Lower 32 bits
00000000,
{% else %}
; Reserved space when MSI-X is used
00000000,
00000000,
{% endif %}

; MSI-X Capability ({{ CAP_OFFSET_MSIX }}-{{ CAP_OFFSET_MSIX + 11 }})
{% if msix_enabled %}
{# Set default values if msix_config.table_offset or msix_config.pba_offset are not defined #}
{% set msix_table_offset = msix_config.table_offset|default(0x1000) %}
{% set msix_table_bir = msix_config.table_bir|default(0) %}
{% set msix_pba_offset = msix_config.pba_offset|default(0x800) %}
{% set msix_pba_bir = msix_config.pba_bir|default(0) %}

; Cap ID=0x11, Next=0x70, Message Control={{ "%04X" % ((msix_config.num_vectors - 1) | safe_int(0)) }}
{# Variables already defined above #}
{{ msix_cap_header }},

; Table Offset/BIR: Offset={{ "%08X" % (msix_table_offset | safe_int(0)) }}, BIR={{ msix_table_bir }}
{# Encode as [31:3]=offset, [2:0]=BIR; require 8-byte alignment #}
{% if (msix_table_offset | safe_int(0)) % 8 != 0 %}
; Error: MSI-X table offset must be 8-byte aligned
{%- error "MSI-X table offset must be 8-byte aligned" %}
{% endif %}
{# Encode as (offset - offset%8) + (bir%8) #}
{% set _tbl_off = (msix_table_offset | safe_int(0)) %}
{% set _tbl_bir = (msix_table_bir | safe_int(0)) %}
{% set table_offset_bir = (_tbl_off - (_tbl_off % 8)) + (_tbl_bir % 8) %}
{{ "%08X" % table_offset_bir }},

; PBA Offset/BIR: Offset={{ "%08X" % (msix_pba_offset | safe_int(0)) }}, BIR={{ msix_pba_bir }}
{# Encode as [31:3]=offset, [2:0]=BIR; require 8-byte alignment #}
{% if (msix_pba_offset | safe_int(0)) % 8 != 0 %}
; Error: MSI-X PBA offset must be 8-byte aligned
{%- error "MSI-X PBA offset must be 8-byte aligned" %}
{% endif %}
{# Encode as (offset - offset%8) + (bir%8) #}
{% set _pba_off = (msix_pba_offset | safe_int(0)) %}
{% set _pba_bir = (msix_pba_bir | safe_int(0)) %}
{% set pba_offset_bir = (_pba_off - (_pba_off % 8)) + (_pba_bir % 8) %}
{{ "%08X" % pba_offset_bir }},
{% else %}
; No MSI-X capability
00000000,
00000000,
00000000,
{% endif %}

; PCIe Capability ({{ CAP_OFFSET_PCIE }}-{{ CAP_OFFSET_PCIE + 63 }})
; Cap ID=0x10, Next=0x00 (end of chain), PCIe Capabilities=0x0002
{% set next_cap = CAP_OFFSET_AER if device_config.enable_advanced_features else 0 %}
{% set pcie_cap_header = "0002" ~ ("%02X" % (next_cap | safe_int(0))) ~ "10" %}
{{ pcie_cap_header }},

; Device Capabilities
00000000,
; Device Control and Status
00000000,
; Link Capabilities
00000000,
; Link Control and Status
00000000,
; Slot Capabilities (if applicable)
00000000,
; Slot Control and Status
00000000,
; Root Capabilities
00000000,
; Root Control and Status
00000000,
; Device Capabilities 2
00000000,
; Device Control 2 and Status 2
00000000,
; Link Capabilities 2
00000000,
; Link Control 2 and Status 2
00000000,
; Slot Capabilities 2
00000000,
; Slot Control 2 and Status 2
00000000,

{% if device_config.enable_advanced_features %}
; =====================================================================
; Advanced Error Reporting Capability ({{ CAP_OFFSET_AER }}-{{ CAP_OFFSET_AER + 63 }})
; =====================================================================
; Cap ID=0x01, Next=0x00, AER Capabilities=0x0000
00000001,
; Uncorrectable Error Status (latched events)
00000000,
; Uncorrectable Error Mask
{% if aer is not defined or not aer %}
; Warning: AER context missing - zeroing uncorrectable error mask
{% endif %}
{{ "%08X" % ((aer.uncorrectable_error_mask if (aer is defined and aer and (aer.uncorrectable_error_mask is defined)) else 0) | safe_int(0)) }},
; Uncorrectable Error Severity
{% if aer is not defined or not aer %}
; Warning: AER context missing - zeroing uncorrectable error severity
{% endif %}
{{ "%08X" % ((aer.uncorrectable_error_severity if (aer is defined and aer and (aer.uncorrectable_error_severity is defined)) else 0) | safe_int(0)) }},
; Correctable Error Status (latched events)
00000000,
; Correctable Error Mask
{% if aer is not defined or not aer %}
; Warning: AER context missing - zeroing correctable error mask
{% endif %}
{{ "%08X" % ((aer.correctable_error_mask if (aer is defined and aer and (aer.correctable_error_mask is defined)) else 0) | safe_int(0)) }},
; Advanced Error Capabilities and Control
{% if aer is not defined or not aer %}
; Warning: AER context missing - zeroing advanced error capabilities
{% endif %}
{{ "%08X" % ((aer.advanced_error_capabilities if (aer is defined and aer and (aer.advanced_error_capabilities is defined)) else 0) | safe_int(0)) }},
; Header Log (4 DWORDs)
00000000,
00000000,
00000000,
00000000,
{% if device_config.enable_error_injection %}
; Optional Error Injection Control (implementation dependent)
; This build enables error injection hooks in HDL (not represented here).
{% endif %}
; Root Error Command
00000000,
; Root Error Status
00000000,
; Error Source Identification
00000000,
; Reserved
00000000,
00000000,
00000000,
{% endif %}

{% if device_config and hasattr(device_config, 'has_manufacturing_variance') and device_config.has_manufacturing_variance %}
; =====================================================================
; Device-Specific Configuration based on Manufacturing Variance
; =====================================================================
{% if timing_config and hasattr(timing_config, 'timing_regularity') %}
{% if timing_config.timing_regularity > 0.8 %}
; High regularity device - optimized timing
{% elif timing_config.timing_regularity < 0.3 %}
; Low regularity device - conservative timing
{% else %}
; Medium regularity device - standard timing
{% endif %}
{% endif %}
{% endif %}

; =====================================================================
; Extended Configuration Space ({{ EXTENDED_CFG_START }}-{{ EXTENDED_CFG_END - 1 }})
; =====================================================================
{# Determine optional extended capabilities. All fields are defensive to keep
   legacy contexts working without additional inputs. #}
{% set aer_cfg = aer if (aer is defined and aer) else {} %}
{% set acs_cfg = acs if (acs is defined) else safe_attr(device_config, 'acs', {}) %}
{% set ats_cfg = ats if (ats is defined) else safe_attr(device_config, 'ats', {}) %}
{% set sriov_cfg = sriov if (sriov is defined) else safe_attr(device_config, 'sriov', {}) %}
{% set pasid_cfg = pasid if (pasid is defined) else safe_attr(device_config, 'pasid', {}) %}
{% set pri_cfg = pri if (pri is defined) else safe_attr(device_config, 'pri', {}) %}
{% set tph_cfg = tph if (tph is defined) else safe_attr(device_config, 'tph', {}) %}
{% set ltr_cfg = ltr if (ltr is defined) else safe_attr(device_config, 'ltr', {}) %}
{% set dpc_cfg = dpc if (dpc is defined) else safe_attr(device_config, 'dpc', {}) %}
{% set resizable_bar_cfg = resizable_bar if (resizable_bar is defined) else safe_attr(device_config, 'resizable_bar', {}) %}
{% set ari_cfg = ari if (ari is defined) else safe_attr(device_config, 'ari', {}) %}
{% set dsn_cfg = dsn if (dsn is defined) else safe_attr(device_config, 'dsn', {}) %}
{% set vc_cfg = virtual_channel if (virtual_channel is defined) else safe_attr(device_config, 'virtual_channel', {}) %}
{% set power_budgeting_cfg = power_budgeting if (power_budgeting is defined) else safe_attr(device_config, 'power_budgeting', {}) %}
{% set ptm_cfg = ptm if (ptm is defined) else safe_attr(device_config, 'ptm', {}) %}
{% set l1pm_cfg = l1pm if (l1pm is defined) else safe_attr(device_config, 'l1pm', {}) %}
{% set secondary_pcie_cfg = secondary_pcie if (secondary_pcie is defined) else safe_attr(device_config, 'secondary_pcie', {}) %}

{% set supports_aer = (device_config.enable_advanced_features if (device_config is defined and device_config.enable_advanced_features is defined) else False) and aer_cfg %}
{% set supports_acs = supports_aer or safe_attr(device_config, 'supports_acs', False) or (acs_cfg is defined and acs_cfg) %}
{% set supports_ats = safe_attr(device_config, 'supports_ats', False) or (ats_cfg is defined and ats_cfg) %}
{% set supports_sriov = safe_attr(device_config, 'supports_sriov', False) or (sriov_cfg is defined and sriov_cfg) %}
{% set supports_pasid = safe_attr(device_config, 'supports_pasid', False) or (pasid_cfg is defined and pasid_cfg) %}
{% set supports_pri = safe_attr(device_config, 'supports_pri', False) or (pri_cfg is defined and pri_cfg) %}
{% set supports_tph = safe_attr(device_config, 'supports_tph', False) or (tph_cfg is defined and tph_cfg) %}
{% set supports_ltr = safe_attr(device_config, 'supports_ltr', False) or (ltr_cfg is defined and ltr_cfg) %}
{% set supports_dpc = safe_attr(device_config, 'supports_dpc', False) or (dpc_cfg is defined and dpc_cfg) %}
{% set supports_resizable_bar = safe_attr(device_config, 'supports_resizable_bar', False) or (resizable_bar_cfg is defined and resizable_bar_cfg) %}
{% set supports_ari = safe_attr(device_config, 'supports_ari', False) or (ari_cfg is defined and ari_cfg) %}
{% set supports_dsn = safe_attr(device_config, 'supports_dsn', False) or (dsn_cfg is defined and dsn_cfg) %}
{% set supports_vc = safe_attr(device_config, 'supports_virtual_channel', False) or (vc_cfg is defined and vc_cfg) %}
{% set supports_power_budgeting = safe_attr(device_config, 'supports_power_budgeting', False) or (power_budgeting_cfg is defined and power_budgeting_cfg) %}
{% set supports_ptm = safe_attr(device_config, 'supports_ptm', False) or (ptm_cfg is defined and ptm_cfg) %}
{% set supports_l1pm = safe_attr(device_config, 'supports_l1pm', False) or (l1pm_cfg is defined and l1pm_cfg) %}
{% set supports_secondary_pcie = safe_attr(device_config, 'supports_secondary_pcie', False) or (secondary_pcie_cfg is defined and secondary_pcie_cfg) %}

{% set ext_caps = namespace(list=[]) %}
{% if supports_aer %}{% set _ = ext_caps.list.append('aer') %}{% endif %}
{% if supports_vc %}{% set _ = ext_caps.list.append('vc') %}{% endif %}
{% if supports_dsn %}{% set _ = ext_caps.list.append('dsn') %}{% endif %}
{% if supports_power_budgeting %}{% set _ = ext_caps.list.append('power_budgeting') %}{% endif %}
{% if supports_acs %}{% set _ = ext_caps.list.append('acs') %}{% endif %}
{% if supports_ats %}{% set _ = ext_caps.list.append('ats') %}{% endif %}
{% if supports_sriov %}{% set _ = ext_caps.list.append('sriov') %}{% endif %}
{% if supports_ari %}{% set _ = ext_caps.list.append('ari') %}{% endif %}
{% if supports_pasid %}{% set _ = ext_caps.list.append('pasid') %}{% endif %}
{% if supports_pri %}{% set _ = ext_caps.list.append('pri') %}{% endif %}
{% if supports_tph %}{% set _ = ext_caps.list.append('tph') %}{% endif %}
{% if supports_ltr %}{% set _ = ext_caps.list.append('ltr') %}{% endif %}
{% if supports_secondary_pcie %}{% set _ = ext_caps.list.append('secondary_pcie') %}{% endif %}
{% if supports_l1pm %}{% set _ = ext_caps.list.append('l1pm') %}{% endif %}
{% if supports_ptm %}{% set _ = ext_caps.list.append('ptm') %}{% endif %}
{% if supports_resizable_bar %}{% set _ = ext_caps.list.append('resizable_bar') %}{% endif %}
{% if supports_dpc %}{% set _ = ext_caps.list.append('dpc') %}{% endif %}

{% if ext_caps.list|length == 0 %}
; Mostly zeros for basic implementation
{% for i in range(EXTENDED_CFG_START, EXTENDED_CFG_END, 4) %}
{% if loop.index % 16 == 1 %}
; Offset {{ "%03X" % (i | safe_int(0)) }}
{% endif %}
00000000{% if not loop.last %},{% endif %}
{% endfor %}
{% else %}
; Extended Capabilities emitted ({{ ext_caps.list|join(', ') }})
{% set ext_offset = EXTENDED_CFG_START %}
{% for cap_name in ext_caps.list %}
  {# Compute capability-specific body and metadata #}
  {% if cap_name == 'dsn' %}
        {% set _dsn_lo = safe_attr(dsn_cfg, 'serial_number_low', safe_attr(device_config, 'device_serial_low', 0x12345678)) | safe_int(0x12345678) %}
        {% set _dsn_hi = safe_attr(dsn_cfg, 'serial_number_high', safe_attr(device_config, 'device_serial_high', 0x9ABCDEF0)) | safe_int(0x9ABCDEF0) %}
        {% set body = [
            _dsn_lo,
            _dsn_hi,
        ] %}
        {% set cap_id = 0x0003 %}
        {% set version = 1 %}
    {% elif cap_name == 'vc' %}
        {% set _vc_count = safe_attr(vc_cfg, 'extended_vc_count', 0) | safe_int(0) %}
        {% set _vc_arb = safe_attr(vc_cfg, 'vc_arbitration', 0) | safe_int(0) %}
        {% set _vc_caps = (_vc_count & 0x7) | ((_vc_arb & 0xF) << 4) %}
        {% set body = [
            _vc_caps,
            0,
            0,
        ] %}
        {% set cap_id = 0x0002 %}
        {% set version = 1 %}
    {% elif cap_name == 'power_budgeting' %}
        {% set _pb_ds = safe_attr(power_budgeting_cfg, 'data_select', 0) | safe_int(0) %}
        {% set _pb_data = safe_attr(power_budgeting_cfg, 'power_data', 0) | safe_int(0) %}
        {% set _pb_caps = safe_attr(power_budgeting_cfg, 'capabilities', 0) | safe_int(0) %}
        {% set body = [
            _pb_ds,
            _pb_data,
            _pb_caps,
        ] %}
        {% set cap_id = 0x0004 %}
        {% set version = 1 %}
    {% elif cap_name == 'ptm' %}
        {% set _ptm_requester = safe_attr(ptm_cfg, 'requester_capable', True) %}
        {% set _ptm_responder = safe_attr(ptm_cfg, 'responder_capable', True) %}
        {% set _ptm_root = safe_attr(ptm_cfg, 'root_capable', False) %}
        {% set _ptm_granularity = safe_attr(ptm_cfg, 'local_clock_granularity', 0xA0) | safe_int(0xA0) %}
        {% set _ptm_caps = ((1 if _ptm_requester else 0) << 0) | ((1 if _ptm_responder else 0) << 1) | ((1 if _ptm_root else 0) << 2) | (_ptm_granularity << 8) %}
        {% set body = [
            _ptm_caps,
            0,
        ] %}
        {% set cap_id = 0x001F %}
        {% set version = 1 %}
    {% elif cap_name == 'l1pm' %}
        {% set _l1pm_aspm_l1_1 = safe_attr(l1pm_cfg, 'aspm_l1_1_supported', True) %}
        {% set _l1pm_aspm_l1_2 = safe_attr(l1pm_cfg, 'aspm_l1_2_supported', True) %}
        {% set _l1pm_pci_pm_l1_1 = safe_attr(l1pm_cfg, 'pci_pm_l1_1_supported', True) %}
        {% set _l1pm_pci_pm_l1_2 = safe_attr(l1pm_cfg, 'pci_pm_l1_2_supported', True) %}
        {% set _l1pm_cm_restore = safe_attr(l1pm_cfg, 'common_mode_restore_time', 0) | safe_int(0) %}
        {% set _l1pm_tpoweron = safe_attr(l1pm_cfg, 't_power_on_scale', 0) | safe_int(0) %}
        {% set _l1pm_caps = (
            ((1 if _l1pm_aspm_l1_1 else 0) << 0)
            | ((1 if _l1pm_aspm_l1_2 else 0) << 1)
            | ((1 if _l1pm_pci_pm_l1_1 else 0) << 2)
            | ((1 if _l1pm_pci_pm_l1_2 else 0) << 3)
            | ((_l1pm_cm_restore & 0xFF) << 8)
            | ((_l1pm_tpoweron & 0x1F) << 19)
        ) %}
        {% set body = [
            _l1pm_caps,
            0,
            0,
        ] %}
        {% set cap_id = 0x001E %}
        {% set version = 1 %}
    {% elif cap_name == 'secondary_pcie' %}
        {% set _sec_link_ctrl3 = safe_attr(secondary_pcie_cfg, 'link_control_3', 0) | safe_int(0) %}
        {% set _sec_lane_err = safe_attr(secondary_pcie_cfg, 'lane_error_status', 0) | safe_int(0) %}
        {% set _sec_eq_ctrl = safe_attr(secondary_pcie_cfg, 'equalization_control', 0) | safe_int(0) %}
        {% set body = [
            _sec_link_ctrl3,
            _sec_lane_err,
            _sec_eq_ctrl,
        ] %}
        {% set cap_id = 0x0019 %}
        {% set version = 1 %}
    {% elif cap_name == 'aer' %}
    {% set body = [
      0,  # Uncorrectable Error Status
      (aer_cfg.uncorrectable_error_mask if (aer_cfg is defined and (aer_cfg.uncorrectable_error_mask is defined)) else 0) | safe_int(0),
      (aer_cfg.uncorrectable_error_severity if (aer_cfg is defined and (aer_cfg.uncorrectable_error_severity is defined)) else 0) | safe_int(0),
      0,  # Correctable Error Status
      (aer_cfg.correctable_error_mask if (aer_cfg is defined and (aer_cfg.correctable_error_mask is defined)) else 0) | safe_int(0),
      (aer_cfg.advanced_error_capabilities if (aer_cfg is defined and (aer_cfg.advanced_error_capabilities is defined)) else 0) | safe_int(0),
      0,0,0,0,  # Header Log
      0,  # Root Error Command
      0,  # Root Error Status
      0,  # Error Source ID
      0,0,0,  # Reserved / impl defined
    ] %}
    {% set cap_id = 0x0001 %}
    {% set version = 1 %}
  {% elif cap_name == 'acs' %}
    {% set _acs_src = safe_attr(acs_cfg, 'source_validation', True) %}
    {% set _acs_tblk = safe_attr(acs_cfg, 'translation_blocking', True) %}
    {% set _acs_req = safe_attr(acs_cfg, 'p2p_request_redirect', True) %}
    {% set _acs_cmp = safe_attr(acs_cfg, 'p2p_completion_redirect', True) %}
    {% set _acs_up = safe_attr(acs_cfg, 'upstream_forwarding', True) %}
    {% set _acs_egr = safe_attr(acs_cfg, 'p2p_egress_control', False) %}
    {% set _acs_dtp = safe_attr(acs_cfg, 'direct_translated_p2p', False) %}
    {% set _acs_caps = (
      (1 if _acs_src else 0)
      | ((1 if _acs_tblk else 0) << 1)
      | ((1 if _acs_req else 0) << 2)
      | ((1 if _acs_cmp else 0) << 3)
      | ((1 if _acs_up else 0) << 4)
      | ((1 if _acs_egr else 0) << 5)
      | ((1 if _acs_dtp else 0) << 6)
    ) %}
    {% set body = [
      _acs_caps,
      _acs_caps,  # Mirror capabilities into control for permissive default
      0,          # ACS Status (reserved/clear)
    ] %}
    {% set cap_id = 0x000D %}
    {% set version = 1 %}
  {% elif cap_name == 'ats' %}
    {% set _ats_stu = (safe_attr(ats_cfg, 'max_stu', safe_attr(device_config, 'ats_stu', 0x8)) | safe_int(0)) & 0x1F %}
    {% set _ats_caps = _ats_stu %}
    {% set _ats_ctrl = safe_attr(ats_cfg, 'control', 0) | safe_int(0) %}
    {% set body = [
      _ats_caps,
      _ats_ctrl,
    ] %}
    {% set cap_id = 0x000F %}
    {% set version = 1 %}
  {% elif cap_name == 'sriov' %}
    {% set _total_vfs = safe_attr(sriov_cfg, 'total_vfs', safe_attr(device_config, 'max_vfs', 0)) | safe_int(0) %}
    {% set _initial_vfs = safe_attr(sriov_cfg, 'initial_vfs', safe_attr(device_config, 'num_vfs', _total_vfs)) | safe_int(0) %}
    {% set _num_vf_bars = safe_attr(sriov_cfg, 'num_vf_bars', 6) | safe_int(0) %}
    {% set _vf_device_id = safe_attr(
      sriov_cfg,
      'vf_device_id',
      (safe_int(device_config.device_id) + 1 if (device_config is defined and device_config.device_id is defined) else 0),
    ) | safe_int(0) %}
    {% set _first_vf_offset = safe_attr(sriov_cfg, 'first_vf_offset', safe_attr(device_config, 'vf_offset', 0x100)) | safe_int(0) %}
    {% set _vf_stride = safe_attr(sriov_cfg, 'vf_stride', safe_attr(device_config, 'vf_stride', 0x10)) | safe_int(0) %}
    {% set _supported_page_sizes = safe_attr(sriov_cfg, 'supported_page_sizes', 0x3) | safe_int(0) %}
    {% set _system_page_size = safe_attr(sriov_cfg, 'system_page_size', 0x1) | safe_int(0) %}
    {% set body = [
      0,              # SR-IOV Capability flags (permissive default)
      0,              # SR-IOV Control
      0,              # SR-IOV Status
      _initial_vfs,   # Initial VFs
      _total_vfs,     # Total VFs
      _initial_vfs,   # Num VFs (runtime configurable)
      0,              # Function Dependency Link
      _first_vf_offset,  # First VF Offset
      _vf_stride,     # VF Stride
      _vf_device_id,  # VF Device ID
      _supported_page_sizes,  # Supported Page Sizes
      _system_page_size,      # System Page Size
      0,              # Reserved
      0,              # VF Migration State
    ] %}
        {% set cap_id = 0x0010 %}
        {% set version = 1 %}
    {% elif cap_name == 'ari' %}
        {% set _ari_mfvc = safe_attr(ari_cfg, 'mfvc_function_groups_capability', False) %}
        {% set _ari_acs = safe_attr(ari_cfg, 'acs_function_groups_capability', False) %}
        {% set _ari_next_fn = safe_attr(ari_cfg, 'next_function_number', 0) | safe_int(0) %}
        {% set _ari_caps = (1 if _ari_mfvc else 0) | ((1 if _ari_acs else 0) << 1) %}
        {% set body = [
            _ari_caps,
            _ari_next_fn,
        ] %}
        {% set cap_id = 0x000E %}
        {% set version = 1 %}
    {% elif cap_name == 'pasid' %}
        {% set _pasid_width = (safe_attr(pasid_cfg, 'max_pasid_width', safe_attr(device_config, 'pasid_width', 20)) | safe_int(20)) & 0x1F %}
        {% set _pasid_priv = safe_attr(pasid_cfg, 'privilege_mode_supported', True) %}
        {% set _pasid_exec = safe_attr(pasid_cfg, 'execute_permission_supported', True) %}
        {% set _pasid_caps = (_pasid_width) | ((1 if _pasid_exec else 0) << 1) | ((1 if _pasid_priv else 0) << 2) %}
        {% set body = [
            _pasid_caps,
            0,
        ] %}
        {% set cap_id = 0x001B %}
        {% set version = 1 %}
    {% elif cap_name == 'pri' %}
        {% set _pri_stopped = safe_attr(pri_cfg, 'stop_supported', True) %}
        {% set _pri_pages = (safe_attr(pri_cfg, 'max_page_requests', 32) | safe_int(32)) & 0xFFFFFFFF %}
        {% set _pri_caps = ((1 if _pri_stopped else 0) << 0) %}
        {% set body = [
            _pri_caps,
            0,
            0,
            _pri_pages,
            _pri_pages,
        ] %}
        {% set cap_id = 0x0013 %}
        {% set version = 1 %}
    {% elif cap_name == 'tph' %}
        {% set _tph_nosteer = safe_attr(tph_cfg, 'no_st_mode_supported', True) %}
        {% set _tph_intvec = safe_attr(tph_cfg, 'interrupt_vector_mode', True) %}
        {% set _tph_devspec = safe_attr(tph_cfg, 'device_specific_mode', True) %}
        {% set _tph_extreq = safe_attr(tph_cfg, 'extended_tph_requester', False) %}
        {% set _tph_loc = safe_attr(tph_cfg, 'st_table_location', 0) | safe_int(0) %}
        {% set _tph_size = safe_attr(tph_cfg, 'st_table_size', 0) | safe_int(0) %}
        {% set _tph_caps = (
            (1 if _tph_nosteer else 0)
            | ((1 if _tph_intvec else 0) << 1)
            | ((1 if _tph_devspec else 0) << 2)
            | ((1 if _tph_extreq else 0) << 8)
            | ((_tph_loc & 0x3) << 9)
            | ((_tph_size & 0x7FF) << 16)
        ) %}
        {% set body = [
            _tph_caps,
            0,
        ] %}
        {% set cap_id = 0x0017 %}
        {% set version = 1 %}
    {% elif cap_name == 'ltr' %}
        {% set _ltr_max_snoop = safe_attr(ltr_cfg, 'max_snoop_latency', safe_attr(device_config, 'ltr_max_snoop_latency', 0x1003)) | safe_int(0x1003) %}
        {% set _ltr_max_nosnoop = safe_attr(ltr_cfg, 'max_no_snoop_latency', safe_attr(device_config, 'ltr_max_no_snoop_latency', 0x1003)) | safe_int(0x1003) %}
        {% set body = [
            (_ltr_max_nosnoop << 16) | _ltr_max_snoop,
        ] %}
        {% set cap_id = 0x0018 %}
        {% set version = 1 %}
    {% elif cap_name == 'resizable_bar' %}
        {% set _rbar_num = safe_attr(resizable_bar_cfg, 'num_resizable_bars', 1) | safe_int(1) %}
        {% set _rbar_sizes = safe_attr(resizable_bar_cfg, 'supported_sizes', 0x1F0) | safe_int(0x1F0) %}
        {% set _rbar_current = safe_attr(resizable_bar_cfg, 'current_size', 0) | safe_int(0) %}
        {% set body = [] %}
        {% for i in range(_rbar_num) %}
            {% set _ = body.append((_rbar_sizes << 4) | (i & 0x7)) %}
            {% set _ = body.append((1 << 4) | _rbar_current) %}
        {% endfor %}
        {% set cap_id = 0x0015 %}
        {% set version = 1 %}
    {% elif cap_name == 'dpc' %}
        {% set _dpc_rp_pio = safe_attr(dpc_cfg, 'rp_pio_log_supported', True) %}
        {% set _dpc_sw_trigger = safe_attr(dpc_cfg, 'sw_trigger_supported', True) %}
        {% set _dpc_log_size = (safe_attr(dpc_cfg, 'rp_pio_log_size', 0) | safe_int(0)) & 0xF %}
        {% set _dpc_caps = (
            ((1 if _dpc_rp_pio else 0) << 4)
            | ((1 if _dpc_sw_trigger else 0) << 5)
            | (_dpc_log_size << 8)
        ) %}
        {% set body = [
            _dpc_caps,
            0,
            0,
            0,
        ] %}
        {% set cap_id = 0x001D %}
        {% set version = 1 %}
    {% else %}
        {% set body = [] %}
        {% set cap_id = 0 %}
        {% set version = 1 %}
    {% endif %}  {% set cap_bytes = (body|length + 1) * 4 %}
  {% set next_offset = (ext_offset + cap_bytes) if not loop.last else 0 %}
  {% set has_more_after = (not loop.last) or (next_offset < EXTENDED_CFG_END) %}
  {% set header_word = ((next_offset | safe_int(0)) << 20) + ((version & 0xF) << 16) + (cap_id & 0xFFFF) %}
{{ "%08X" % header_word }}{% if body or has_more_after %},{% endif %}
  {% for word in body %}
{{ "%08X" % (word | safe_int(0)) }}{% if not (loop.last and not has_more_after and next_offset >= EXTENDED_CFG_END) %},{% endif %}
  {% endfor %}
  {% set ext_offset = ext_offset + cap_bytes %}
{% endfor %}
  {% for i in range(ext_offset, EXTENDED_CFG_END, 4) %}
{% if loop.index0 % 16 == 0 %}; Offset {{ "%03X" % ((ext_offset + (loop.index0*4)) | safe_int(0)) }}{% endif %}
00000000{% if not loop.last %},{% endif %}
  {% endfor %}
{% endif %};

; =====================================================================
; PCILeech-Specific Configuration Metadata
; =====================================================================
; This section contains device-specific configuration derived from behavior analysis
;
{% if device_config is defined and hasattr(device_config, 'behavior_profile') and device_config.behavior_profile %}
; Behavior Profile Summary:
; - Total Register Accesses: {{ device_config.total_register_accesses }}
; - Capture Duration: {{ device_config.capture_duration }}s
; - Timing Patterns: {{ device_config.timing_patterns_count }}
; - State Transitions: {{ device_config.state_transitions_count }}
{% endif %}
;
; PCILeech Configuration:
{% if not pcileech_config.command_timeout %}
{%- error "PCILeech command timeout is required - no fallback values allowed" %}
{% endif %}
; - Command Timeout: {{ pcileech_config.command_timeout }} cycles
{% if not pcileech_config.buffer_size %}
{%- error "PCILeech buffer size is required - no fallback values allowed" %}
{% endif %}
; - Buffer Size: {{ pcileech_config.buffer_size }} bytes
{% if pcileech_config.enable_dma is not defined %}
{%- error "PCILeech DMA operations setting is required - no fallback values allowed" %}
{% endif %}
; - DMA Operations: {{ pcileech_config.enable_dma }}
{% if pcileech_config.enable_scatter_gather is not defined %}
{%- error "PCILeech scatter-gather setting is required - no fallback values allowed" %}
{% endif %}
; - Scatter-Gather: {{ pcileech_config.enable_scatter_gather }}
;
; Timing Configuration:
{% if not timing_config.read_latency %}
{%- error "Timing read latency is required - no fallback values allowed" %}
{% endif %}
; - Read Latency: {{ timing_config.read_latency }} cycles
{% if not timing_config.write_latency %}
{%- error "Timing write latency is required - no fallback values allowed" %}
{% endif %}
; - Write Latency: {{ timing_config.write_latency }} cycles
{% if not timing_config.burst_length %}
{%- error "Timing burst length is required - no fallback values allowed" %}
{% endif %}
; - Burst Length: {{ timing_config.burst_length }}
{% if not timing_config.clock_frequency_mhz %}
{%- error "Timing clock frequency is required - no fallback values allowed" %}
{% endif %}
; - Clock Frequency: {{ timing_config.clock_frequency_mhz }} MHz
;
; BAR Configuration (using safe defaults when values are missing):
{# Use safe_attr to avoid TemplateObject attribute errors during migration #}
{% set primary_bar_index = safe_attr(bar_config, 'bar_index', 0) %}
; - Primary BAR Index: {{ primary_bar_index }}
{% set aperture_size = safe_attr(bar_config, 'aperture_size', 0) %}
; - Aperture Size: {{ aperture_size }} bytes
{% set bar_type = safe_attr(bar_config, 'bar_type', 0) %}
; - BAR Type: {{ bar_type }} (0=32-bit, 1=64-bit)
{% set prefetchable = safe_attr(bar_config, 'prefetchable', false) %}
; - Prefetchable: {{ prefetchable }}
